name: ü§ñ Auto Version & Discord Notify

on:
  push:
    branches:
      - main
  workflow_dispatch:  # permite rodar manualmente tamb√©m

jobs:
  auto_version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      # 1Ô∏è‚É£ Detecta se o commit cont√©m uma vers√£o (ex: v2.4.0)
      - name: Detectar n√∫mero de vers√£o no commit
        id: version
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "üß© Mensagem do commit: $COMMIT_MSG"
          if [[ "$COMMIT_MSG" =~ v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            VERSION=$(echo "$COMMIT_MSG" | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+")
            echo "‚úÖ Vers√£o detectada: $VERSION"
            echo "VERSION=$VERSION" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è Nenhuma vers√£o detectada ‚Äî commit normal."
            echo "SKIP=true" >> $GITHUB_ENV
          fi

      # 2Ô∏è‚É£ Cria e envia a tag automaticamente, se tiver vers√£o
      - name: Criar tag autom√°tica
        if: env.SKIP != 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag $VERSION
          git push origin $VERSION
          echo "üè∑Ô∏è Tag $VERSION criada e enviada."

      # 3Ô∏è‚É£ Extrai a √∫ltima entrada do changelog
      - name: Obter changelog recente
        if: env.SKIP != 'true'
        run: |
          LATEST_CHANGELOG=$(awk '/^## /{if (NR!=1) exit} {print}' changelog.md)
          echo "LATEST_CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$LATEST_CHANGELOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "üìú √öltimo changelog preparado."

      # 4Ô∏è‚É£ Envia mensagem para o Discord
      - name: Enviar notifica√ß√£o ao Discord
        if: env.SKIP != 'true'
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            üéØ **Nova vers√£o `${{ env.VERSION }}` publicada automaticamente!**
            üßô **Reposit√≥rio:** [`${{ github.repository }}`](https://github.com/${{ github.repository }})
            üë§ **Autor:** `${{ github.actor }}`
            üïê **Data:** `${{ github.event.head_commit.timestamp }}`
            üìù **Changelog:**
            ${{ env.LATEST_CHANGELOG }}

      # 5Ô∏è‚É£ Mensagem de sucesso no log
      - name: Confirmar envio
        if: env.SKIP != 'true'
        run: echo "‚úÖ Vers√£o $VERSION publicada e notificada com sucesso!"
