name: ğŸ¤– Auto Version & Discord Embed (Lyra Debug Mode)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  auto_version:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Detectar nÃºmero de versÃ£o no commit
      - name: Detectar nÃºmero de versÃ£o no commit
        id: version
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" =~ v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            VERSION=$(echo "$COMMIT_MSG" | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+")
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "ğŸ§™ VersÃ£o detectada: $VERSION"
          else
            echo "SKIP=true" >> $GITHUB_ENV
            echo "âš ï¸ Nenhum nÃºmero de versÃ£o encontrado no commit."
          fi

      # 3ï¸âƒ£ Atualizar badge de versÃ£o no README
      - name: Atualizar badge de versÃ£o no README
        if: env.SKIP != 'true'
        run: |
          sed -i -E "s/Version-[0-9]+\.[0-9]+\.[0-9]+/Version-${VERSION}/" readme.md
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add readme.md
          git commit -m "ğŸ”– Atualiza badge para ${VERSION}" || true
          git push || true

      # 4ï¸âƒ£ Criar tag automÃ¡tica (modo seguro)
      - name: Criar tag automÃ¡tica (modo seguro)
        if: env.SKIP != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          if git ls-remote --tags origin | grep -q "refs/tags/$VERSION$"; then
            echo "âš ï¸ Tag $VERSION jÃ¡ existe. Pulando criaÃ§Ã£o."
          else
            git tag $VERSION
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git $VERSION
          fi

      # 5ï¸âƒ£ Extrair changelog da Ãºltima versÃ£o
      - name: Extrair changelog mais recente
        if: env.SKIP != 'true'
        run: |
          echo "ğŸ” Extraindo changelog da versÃ£o mais recente..."
          awk '
            /^## \[/ {
              if (found) exit;
              found=1; next;
            }
            found
          ' changelog.md > changelog_temp.md

          if [ ! -s changelog_temp.md ]; then
            echo "âš ï¸ Nenhum changelog encontrado."
            echo "Nenhum changelog encontrado." > changelog_temp.md
          fi

          echo "âœ… changelog_temp.md criado:"
          head -n 15 changelog_temp.md || true

      # 6ï¸âƒ£ Enviar changelog mais recente ao Discord (modo DEBUG)
      - name: Enviar changelog mais recente ao Discord (modo debug)
        if: env.SKIP != 'true'
        run: |
          echo "ğŸ’¬ Preparando envio do changelog da Ãºltima versÃ£o (modo debug)..."

          VERSION="${{ env.VERSION }}"
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          SHA="${{ github.sha }}"
          DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          WEBHOOK="${{ secrets.DISCORD_WEBHOOK }}"

          echo "ğŸ“œ Carregando changelog real..."
          CHANGELOG_TEXT=$(cat changelog_temp.md)
          echo "ğŸ“ Tamanho original: $(echo "$CHANGELOG_TEXT" | wc -c) bytes"

          # Divide o texto em partes de ~900 caracteres reais
          echo "$CHANGELOG_TEXT" | awk '
            BEGIN { part=1; count=0 }
            {
              len=length($0)+1
              if (count+len>900) { part++; count=0 }
              file=sprintf("changelog_part_%03d.txt", part)
              print $0 >> file
              count+=len
            }'

          total_parts=$(ls changelog_part_*.txt | wc -l)
          echo "ğŸ“š Total de partes a enviar: $total_parts"

          part_count=0
          for FILE in changelog_part_*.txt; do
            part_count=$((part_count+1))
            CHUNK=$(cat "$FILE")
            SIZE=$(echo "$CHUNK" | wc -c)

            echo -e "\033[36mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
            echo -e "ğŸ“¦ Parte $part_count / $total_parts â€” Tamanho: ${SIZE} bytes"
            echo -e "\033[36mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"

            if [ $part_count -eq 1 ]; then
              INTRO="ğŸ¶ *O bardo toca sua harpa e anuncia a nova versÃ£o...* âœ¨"
            else
              INTRO=""
            fi

            PAYLOAD=$(jq -n \
              --arg username "The Bard" \
              --arg avatar "https://raw.githubusercontent.com/Leosdc/lyra-the-wise/main/assets/lyra_avatar.png" \
              --arg version "$VERSION" \
              --arg repo "$REPO" \
              --arg actor "$ACTOR" \
              --arg date "$DATE" \
              --arg sha "$SHA" \
              --arg part "$CHUNK" \
              --arg partnum "$part_count" \
              --arg total "$total_parts" \
              --arg intro "$INTRO" \
              '
              {
                "username": $username,
                "avatar_url": $avatar,
                "content": $intro,
                "embeds": [
                  {
                    "title": ("ğŸ§™ Nova versÃ£o \($version) publicada! (Parte " + $partnum + " de " + $total + ")"),
                    "color": 11259375,
                    "fields": [
                      { "name": "ğŸ“¦ RepositÃ³rio", "value": ("[\($repo)](https://github.com/\($repo))"), "inline": true },
                      { "name": "ğŸ‘¤ Autor", "value": $actor, "inline": true },
                      { "name": "ğŸ• Data", "value": $date, "inline": false },
                      { "name": "ğŸª¶ Changelog", "value": ("```md\n" + $part + "\n```"), "inline": false },
                      { "name": "ğŸ§© Debug Info", "value": ("Parte: " + $partnum + " / " + $total + " | Tamanho: " + ($part|length|tostring) + " chars"), "inline": false }
                    ],
                    "thumbnail": { "url": "https://raw.githubusercontent.com/Leosdc/lyra-the-wise/main/assets/lyra_icon.png" },
                    "footer": { "text": "Lyra the Wise â€¢ Build automÃ¡tico do GitHub Actions" },
                    "url": ("https://github.com/\($repo)/commit/\($sha)")
                  }
                ]
              }')

            echo "ğŸ” PrÃ©-visualizaÃ§Ã£o do payload (primeiras 25 linhas):"
            echo "$PAYLOAD" | head -n 25

            echo "ğŸš€ Enviando para Discord..."
            RESPONSE=$(curl -v -s -o response.txt -w "%{http_code}" \
              -X POST -H "Content-Type: application/json" \
              -d "$PAYLOAD" "$WEBHOOK")

            echo "ğŸ“¨ CÃ³digo HTTP retornado: $RESPONSE"
            echo "ğŸ“œ Resposta do Discord:"
            cat response.txt || echo "(sem resposta)"

            if [ "$RESPONSE" -eq 204 ]; then
              echo -e "\033[32mâœ… Parte $part_count enviada com sucesso!\033[0m"
            else
              echo -e "\033[31mâŒ Erro ao enviar parte $part_count (HTTP $RESPONSE)\033[0m"
            fi
            sleep 2
          done

          echo -e "\033[32mâœ… Todas as partes do changelog foram processadas!\033[0m"

      # 7ï¸âƒ£ ConfirmaÃ§Ã£o final
      - name: Confirmar publicaÃ§Ã£o
        if: env.SKIP != 'true'
        run: echo "ğŸ‰ VersÃ£o ${VERSION} publicada e changelog enviado ao Discord com sucesso!"
