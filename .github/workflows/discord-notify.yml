name: Discord Notify
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ Checkout para ler o arquivo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Extrai apenas o bloco da Ãºltima versÃ£o no changelog.md
      - name: Extract latest changelog entry
        id: changelog
        run: |
          # Encontra o inÃ­cio da primeira versÃ£o (a mais recente)
          start_line=$(grep -n '^## \[' changelog.md | head -n 1 | cut -d: -f1)

          # Encontra o inÃ­cio da prÃ³xima versÃ£o (para saber onde parar)
          next_line=$(grep -n '^## \[' changelog.md | sed -n '2p' | cut -d: -f1)

          if [ -z "$next_line" ]; then
            # Se nÃ£o houver prÃ³xima versÃ£o, pega atÃ© o final do arquivo
            end_line=$(wc -l < changelog.md)
          else
            end_line=$((next_line - 1))
          fi

          # Extrai apenas esse intervalo e salva em variÃ¡vel
          content=$(sed -n "${start_line},${end_line}p" changelog.md)

          # Exporta para ambiente
          echo "LATEST_changelog<<EOF" >> $GITHUB_ENV
          echo "$content" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 3ï¸âƒ£ Envia notificaÃ§Ã£o para o Discord
      - name: Send Discord Notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            ğŸ§™ **AtualizaÃ§Ã£o detectada em `${{ github.repository }}`**
            ğŸ‘¤ Autor: `${{ github.actor }}`
            ğŸ“ Commit: ${{ github.event.head_commit.message || 'Sem mensagem de commit' }}
            ğŸŒ¿ Branch: `${{ github.ref_name }}`
            ğŸ”— [Ver commit](${{ github.event.head_commit.url }})

            ğŸ“œ **Ãšltimas alteraÃ§Ãµes:**
            ```
            ${{ env.LATEST_changelog }}
            ```
